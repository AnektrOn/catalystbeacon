# ============================================================
# DEPLOY SCRIPT - COPY AND PASTE INTO TERMINAL
# ============================================================
# Copy everything below this line and paste into your terminal
# ============================================================

bash << 'DEPLOY_EOF'
set -e

APP_DIR=~/domains/humancatalystbeacon.com/public_html/app
ROOT_DIR=~/domains/humancatalystbeacon.com/public_html

echo "ğŸš€ Deploying HC University..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

cd $APP_DIR

# Step 1: Force Sync with GitHub (Fixes the "Aborting" error)
echo "ğŸ“¥ Step 1: Force cleaning local changes and pulling..."
git fetch origin main
git reset --hard origin/main
echo "   âœ… Code updated and local conflicts cleared"
echo ""

# Step 2: Dependencies (Optimized - avoids full cleanup for speed)
echo "ğŸ“¦ Step 2: Installing dependencies..."
npm install --legacy-peer-deps

# Verify critical dependencies are installed
echo "   ğŸ” Verifying critical dependencies..."
MISSING_DEPS=0

if [ ! -d "node_modules/ajv" ]; then
    echo "   âš ï¸  ajv missing, installing..."
    npm install ajv@^8.12.0 --legacy-peer-deps --save-dev
fi

if [ ! -f "node_modules/ajv/dist/compile/codegen.js" ]; then
    echo "   âš ï¸  ajv codegen missing, reinstalling ajv..."
    rm -rf node_modules/ajv node_modules/ajv-keywords
    npm install ajv@^8.12.0 ajv-keywords@^5.1.0 --legacy-peer-deps --save-dev
fi

if [ ! -d "node_modules/react-app-rewired" ]; then
    echo "   âŒ react-app-rewired missing!"
    MISSING_DEPS=1
fi

if [ $MISSING_DEPS -eq 1 ]; then
    echo "   âŒ Critical dependencies missing! Reinstalling..."
    npm install --legacy-peer-deps --force
fi

echo "   âœ… Dependencies ready"
echo ""

# Step 3: Ensure environment variables are available for build
echo "ğŸ”§ Step 3a: Checking environment variables..."
if [ ! -f ".env" ] && [ ! -f ".env.production" ]; then
    echo "   âŒ ERROR: No .env or .env.production file found!"
    echo "   Please create .env file with REACT_APP_SUPABASE_URL and REACT_APP_SUPABASE_ANON_KEY"
    exit 1
fi

if [ -f ".env" ]; then
    echo "   âœ… Found .env file"
    if grep -q "REACT_APP_SUPABASE_URL" .env && grep -q "REACT_APP_SUPABASE_ANON_KEY" .env; then
        echo "   âœ… .env contains required Supabase variables"
    else
        echo "   âŒ ERROR: .env file missing REACT_APP_SUPABASE_URL or REACT_APP_SUPABASE_ANON_KEY"
        exit 1
    fi
elif [ -f ".env.production" ]; then
    echo "   âœ… Found .env.production file"
    if grep -q "REACT_APP_SUPABASE_URL" .env.production && grep -q "REACT_APP_SUPABASE_ANON_KEY" .env.production; then
        echo "   âœ… .env.production contains required Supabase variables"
    else
        echo "   âŒ ERROR: .env.production missing REACT_APP_SUPABASE_URL or REACT_APP_SUPABASE_ANON_KEY"
        exit 1
    fi
fi
echo ""

# Step 3: Build without minification (Anti-EAGAIN)
echo "ğŸ”¨ Step 3b: Building (Low RAM Mode)..."
rm -rf build
export NODE_OPTIONS='--max-old-space-size=4096'
export GENERATE_SOURCEMAP=false
export BUILD_NO_MINIFY=true

echo "   Building with NODE_ENV=production..."
echo "   (This may take 3-5 minutes, please wait...)"
echo ""

# Run build and capture output
BUILD_OUTPUT=$(NODE_ENV=production npm run build:no-minify 2>&1 || npm run build 2>&1)
BUILD_EXIT_CODE=$?

# Display build output
echo "$BUILD_OUTPUT"

# Check if build failed
if [ $BUILD_EXIT_CODE -ne 0 ]; then
    echo ""
    echo "   âŒ Build failed with exit code: $BUILD_EXIT_CODE"
    echo "   ğŸ“‹ Last 20 lines of build output:"
    echo "$BUILD_OUTPUT" | tail -20
    echo ""
    echo "   ğŸ’¡ Common fixes:"
    echo "      - Check for syntax errors in the code"
    echo "      - Verify all dependencies are installed"
    echo "      - Try: rm -rf node_modules/.cache && npm run build:no-minify"
    exit 1
fi

echo ""
echo "   âœ… Build completed successfully"
echo ""

# Step 4: Verify build
echo "ğŸ“‹ Step 4: Verifying build..."
if [ ! -f "build/index.html" ]; then
    echo "   âŒ Build failed - index.html missing!"
    echo ""
    echo "   ğŸ” Troubleshooting steps:"
    echo "      1. Check if build directory exists: ls -la build/"
    echo "      2. Check build errors above"
    echo "      3. Try running: bash diagnose-build.sh"
    echo "      4. Check for syntax errors in recent code changes"
    echo ""
    exit 1
fi

if ! grep -q "static/js" build/index.html; then
    echo "   âŒ Build incomplete - missing JS references!"
    exit 1
fi

JS_COUNT=$(find build/static/js -name "*.js" 2>/dev/null | wc -l)
echo "   âœ… Build successful: $JS_COUNT JavaScript files"
echo ""

# Step 5: Critical Deployment to Domain Root (Fixes 404/403)
echo "ğŸšš Step 5: Synchronizing build with server root..."
cp -r build/* .
echo "   âœ… Build files synchronized"
echo ""

# Step 6: Fix Permissions & .htaccess
echo "ğŸ”§ Step 6: Setting permissions and routing..."
chmod -R 755 .
find . -type f -exec chmod 644 {} \;
chmod 755 deploy.sh 2>/dev/null || true

# CrÃ©ation du .htaccess pour gÃ©rer React Router sur LiteSpeed
cat <<EOT > .htaccess
RewriteEngine On
RewriteBase /

# IMPORTANT: Health redirect MUST be first, before any other rules
# Redirect /health to /api/health (for backward compatibility)
RewriteCond %{REQUEST_URI} ^/health$
RewriteRule ^health$ /api/health [R=301,L]

# Proxy API requests to Node.js server (including /api/health)
RewriteCond %{REQUEST_URI} ^/api/
RewriteRule ^api/(.*)$ http://localhost:3001/api/$1 [P,L]

# Serve React app (catch-all for SPA routing)
# Exclude /health and /api/* from catch-all
Options -MultiViews
RewriteCond %{REQUEST_URI} !^/health$
RewriteCond %{REQUEST_URI} !^/api/
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ index.html [L]
EOT
echo "   âœ… Permissions and .htaccess configured"
echo ""

# Step 7: Restart PM2
echo "ğŸ”„ Step 7: Restarting PM2 Backend..."
if [ -f "server.env" ]; then
    export $(grep -v '^#' server.env | xargs)
fi
pm2 restart hcuniversity-app --update-env || pm2 start npm --name "hcuniversity-app" -- start
pm2 save
echo "   âœ… PM2 updated"
echo ""

# Step 8: Check status
echo "ğŸ“Š Step 8: Checking status..."
sleep 2
pm2 list | grep hcuniversity-app || echo "   âš ï¸  PM2 process not found (may need manual start)"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… DEPLOYMENT COMPLETE!"
echo "ğŸŒ URL: https://app.humancatalystbeacon.com"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
DEPLOY_EOF
