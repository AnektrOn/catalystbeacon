bash << 'DEPLOY_EOF'
set -e

# --- CONFIGURATION ---
APP_DIR=~/domains/humancatalystbeacon.com/public_html/app
# ---------------------

echo "ðŸš€ DÃ‰PLOIEMENT SÃ‰CURISÃ‰ (AVEC PROTECTION DES CLES)..."
cd $APP_DIR

# 0. SAUVEGARDE DES CLES (La protection ultime)
echo "ðŸ›¡ï¸ 0. Sauvegarde du fichier server.env..."
if [ -f "server.env" ]; then
    cp server.env /tmp/server.env.backup
    echo "   âœ… ClÃ©s mises en sÃ©curitÃ© dans /tmp"
else
    echo "   âš ï¸ Attention : Pas de server.env trouvÃ© !"
fi

# 1. Mise Ã  jour du code source
echo "ðŸ“¥ 1. RÃ©cupÃ©ration du code Git..."
git fetch origin main
git reset --hard origin/main

# 2. RESTAURATION DES CLES
echo "ðŸ›¡ï¸ 2. Restauration du fichier server.env..."
if [ -f "/tmp/server.env.backup" ]; then
    mv /tmp/server.env.backup server.env
    echo "   âœ… ClÃ©s restaurÃ©es avec succÃ¨s !"
fi

# 3. Installation des dÃ©pendances
echo "ðŸ“¦ 3. VÃ©rification des dÃ©pendances..."
chmod +x node_modules/.bin/* 2>/dev/null || true

# 4. Build (MÃ©thode Directe Node.js)
echo "ðŸ”¨ 4. Construction du build..."
rm -rf build
export NODE_OPTIONS='--max-old-space-size=4096'
export GENERATE_SOURCEMAP=false
export BUILD_NO_MINIFY=true

echo "   Execution directe du compilateur..."
node node_modules/react-app-rewired/bin/index.js build

# 5. NETTOYAGE NUCLÃ‰AIRE
echo "ðŸ§¹ 5. Suppression des anciens fichiers..."
rm -rf static
rm -f index.html
rm -f pay.html
rm -f asset-manifest.json

# 6. DÃ©ploiement
echo "ðŸšš 6. Copie des nouveaux fichiers..."
cp -r build/* .

# 7. Configuration .htaccess
echo "ðŸ”§ 7. Configuration .htaccess..."
cat <<EOT > .htaccess
Options -MultiViews
RewriteEngine On
RewriteBase /
RewriteCond %{REQUEST_URI} ^/health$
RewriteRule ^health$ /api/health [R=301,L]
RewriteCond %{REQUEST_URI} ^/api/
RewriteRule ^api/(.*)$ http://127.0.0.1:3001/api/\$1 [P,L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ index.html [L]
EOT

# 8. RedÃ©marrage Backend
echo "ðŸ”„ 8. RedÃ©marrage PM2..."
# On force le rechargement des variables restaurÃ©es
pm2 delete hcuniversity-app 2>/dev/null || true
pm2 start server.js --name "hcuniversity-app"
pm2 save

echo "âœ… DÃ‰PLOIEMENT TERMINÃ‰ ET SÃ‰CURISÃ‰ !"
DEPLOY_EOF